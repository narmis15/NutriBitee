@* Login / Signup modal partial *@
<div id="authModal" class="modal fade" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Welcome to NutriBite</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <ul class="nav nav-tabs mb-3" id="authTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#loginPane" type="button" role="tab">Login</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="signup-tab" data-bs-toggle="tab" data-bs-target="#signupPane" type="button" role="tab">Sign up</button>
          </li>
        </ul>

        <div class="tab-content">
          <div class="tab-pane fade show active" id="loginPane" role="tabpanel">
            <form id="loginForm">
              <div class="mb-2">
                <label class="form-label small">Email</label>
                <input name="email" type="email" class="form-control form-control-sm" required />
              </div>
              <div class="mb-2">
                <label class="form-label small">Password</label>
                <input name="password" type="password" class="form-control form-control-sm" required />
              </div>
              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-cta">Login</button>
              </div>
            </form>
          </div>

          <div class="tab-pane fade" id="signupPane" role="tabpanel">
            <form id="signupForm">
              <div class="mb-2">
                <label class="form-label small">Name</label>
                <input name="name" type="text" class="form-control form-control-sm" />
              </div>
              <div class="mb-2">
                <label class="form-label small">Email</label>
                <input name="email" type="email" class="form-control form-control-sm" required />
              </div>
              <div class="mb-2">
                <label class="form-label small">Password</label>
                <input name="password" type="password" class="form-control form-control-sm" required />
              </div>
              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-cta">Create account</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="modal-footer small text-muted">
        By signing in you agree to our terms.
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>

    <script>
        (function () {
            // open modal programmatically
            window.showAuthModal = function (tab) {
                var modalEl = document.getElementById('authModal');
                var m = new bootstrap.Modal(modalEl);
                if (tab === 'signup') $('#signup-tab').trigger('click');
                else $('#login-tab').trigger('click');
                m.show();
            };

            // login submit
            $('#loginForm').on('submit', function (e) {
                e.preventDefault();
                var data = $(this).serialize();
                $.post('/Auth/Login', data + '&__RequestVerificationToken=' + ($('input[name="__RequestVerificationToken"]').first().val() || '' ))
                    .done(function (res) {
                        if (res.success) {
                            // close modal
                            var modal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
                            modal.hide();
                            // update topbar
                            $('#authBtn').text(res.userName).attr('data-logged', '1');
                            // trigger global event so pages can resume action
                            document.dispatchEvent(new CustomEvent('user:login', { detail: res }));
                        } else {
                            alert(res.message || 'Login failed');
                        }
                    })
                    .fail(function () { alert('Login failed'); });
            });

            // signup submit
            $('#signupForm').on('submit', function (e) {
                e.preventDefault();
                var data = $(this).serialize();
                $.post('/Auth/Register', data + '&__RequestVerificationToken=' + ($('input[name="__RequestVerificationToken"]').first().val() || ''))
                    .done(function (res) {
                        if (res.success) {
                            var modal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
                            modal.hide();
                            $('#authBtn').text(res.userName).attr('data-logged', '1');
                            document.dispatchEvent(new CustomEvent('user:login', { detail: res }));
                        } else {
                            alert(res.message || 'Registration failed');
                        }
                    }).fail(function () { alert('Registration failed'); });
            });

            // update button label at load
            $(function () {
                $.getJSON('/Auth/IsAuthenticated').done(function (res) {
                    if (res && res.authenticated) $('#authBtn').text(res.userName).attr('data-logged', '1');
                });
            });
        })();
    </script>
}