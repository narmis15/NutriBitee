@{
    ViewData["Title"] = "Location Analytics";
}

<link rel="stylesheet" href="~/css/reports.css" />

<div class="table-wrapper reports-page">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4>Location Analytics</h4>
            <small class="text-muted">Demand distribution across cities and regions</small>
        </div>

        <div class="d-flex gap-2 align-items-center">
            <label class="mb-0 small">City</label>
            <select id="cityFilter" class="form-select form-select-sm ms-2"></select>
            <button id="applyFilter" class="btn btn-sm btn-approve ms-2">Apply</button>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-6">
            <div class="card p-3 mb-3">
                <h5 class="mb-2">Locations</h5>
                <div class="table-responsive">
                    <table class="table admin-table" id="locationTable">
                        <thead>
                            <tr>
                                <th>City</th>
                                <th>Region</th>
                                <th>Orders</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card p-3 mb-3">
                <h5 class="mb-2">Demand by Location</h5>
                <canvas id="locationChart" height="260"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        (function () {
            const api = '/Reports/GetLocationAnalyticsData';
            const $city = $('#cityFilter');

            function populateCities(list, selected) {
                $city.empty();
                (list || []).forEach(c => {
                    $city.append($('<option>').attr('value', c).text(c));
                });
                if (selected) $city.val(selected);
            }

            function renderTable(rows) {
                const $tbody = $('#locationTable tbody').empty();
                if (!rows || rows.length === 0) {
                    $tbody.append('<tr><td colspan="4" class="no-records">No data</td></tr>');
                    return;
                }
                rows.forEach(r => {
                    const tr = $('<tr>');
                    tr.append($('<td>').text(r.city || r.City));
                    tr.append($('<td>').text(r.region || r.Region));
                    tr.append($('<td>').text(r.ordersCount ?? r.OrdersCount));
                    tr.append($('<td>').text((r.percentage ?? r.Percentage ?? 0).toFixed(2) + '%'));
                    $tbody.append(tr);
                });
            }

            let chart = null;
            function renderChart(points) {
                const labels = (points || []).map(p => p.label || p.Label);
                const data = (points || []).map(p => p.value ?? p.Value);

                const ctx = document.getElementById('locationChart').getContext('2d');
                if (chart) {
                    chart.data.labels = labels;
                    chart.data.datasets[0].data = data;
                    chart.update();
                    return;
                }

                chart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                '#16a34a','#60a5fa','#f59e0b','#ef4444','#a78bfa','#34d399','#f97316'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { boxWidth: 12 } }
                        }
                    }
                });
            }

            function fetch(city) {
                $.getJSON(api, { city: city || 'All' })
                    .done(function (res) {
                        if (res.error) {
                            alert('Error: ' + res.error);
                            return;
                        }
                        populateCities(res.cities || res.Cities || [], res.selectedCity || res.SelectedCity);
                        renderTable(res.locations || res.Locations || []);
                        renderChart(res.chart || res.Chart || []);
                    })
                    .fail(function () {
                        alert('Failed to load location analytics data');
                    });
            }

            $(function () {
                fetch(); // initial load
                $('#applyFilter').on('click', function () {
                    fetch($city.val());
                });
            });
        })();
    </script>
}
