@{
    ViewData["Title"] = "Order Reports";
}

<link rel="stylesheet" href="~/css/reports.css" />

<div class="reports-page table-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4>Order Reports</h4>
            <small class="text-muted">Filter and inspect orders over a date range</small>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <label class="mb-0 small">From</label>
            <input id="fromDate" type="date" class="form-control form-control-sm" />
            <label class="mb-0 small ms-2">To</label>
            <input id="toDate" type="date" class="form-control form-control-sm" />
            <select id="statusFilter" class="form-select form-select-sm ms-2">
                <option value="All">All</option>
                <option>New</option>
                <option>Accepted</option>
                <option>Ready for Pickup</option>
                <option>Picked</option>
                <option>Cancelled</option>
            </select>
            <button id="applyFilters" class="btn btn-sm btn-approve ms-2">Apply</button>
        </div>
    </div>

    <!-- Summary cards -->
    <div id="summaryCards" class="row g-3 mb-3"></div>

    <!-- Table (first) -->
    <div class="card p-3 mb-3">
        <h5 class="mb-2">Orders</h5>
        <div class="table-responsive">
            <table id="ordersTable" class="table admin-table table-striped">
                <thead>
                    <tr>
                        <th data-key="OrderId">Order</th>
                        <th data-key="OrderDate">Date</th>
                        <th data-key="CustomerName">Customer</th>
                        <th data-key="ItemsCount">Items</th>
                        <th data-key="PickupSlot">Pickup Slot</th>
                        <th data-key="Amount">Amount</th>
                        <th data-key="PaymentStatus">Payment</th>
                        <th data-key="Status">Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Chart (second) -->
    <div class="card p-3">
        <h5 class="mb-2">Order Trend</h5>
        <canvas id="ordersTrendChart" height="120"></canvas>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        (function () {
            const url = '/Reports/GetOrderReportsData';
            const $from = $('#fromDate');
            const $to = $('#toDate');
            const $status = $('#statusFilter');

            function initDefaults() {
                const today = new Date();
                const prior = new Date();
                prior.setDate(today.getDate() - 13);
                $from.val(prior.toISOString().slice(0,10));
                $to.val(today.toISOString().slice(0,10));
            }

            function renderSummary(summary) {
                const $c = $('#summaryCards').empty();
                summary.forEach(s => {
                    const col = $(`<div class="col-md-3"><div class="summary-card p-3 h-100"><div class="title">${s.title || s.Title}</div><div class="value">${s.value || s.Value}</div><div class="sub text-muted">${s.subText || s.SubText}</div></div></div>`);
                    $c.append(col);
                });
            }

            function renderTable(rows) {
                const $tbody = $('#ordersTable tbody').empty();
                rows.forEach(r => {
                    const date = new Date(r.orderDate || r.OrderDate).toLocaleString();
                    const tr = $('<tr></tr>');
                    tr.append('<td><a href="/Admin/OrderDetails?orderId=' + r.orderId + '">#' + r.orderId + '</a></td>');
                    tr.append('<td>' + date + '</td>');
                    tr.append('<td>' + (r.customerName || '-') + '</td>');
                    tr.append('<td>' + (r.itemsCount || 0) + '</td>');
                    tr.append('<td>' + (r.pickupSlot || '-') + '</td>');
                    tr.append('<td>₹' + (Number(r.amount).toFixed(2)) + '</td>');
                    tr.append('<td>' + (r.paymentStatus || '-') + '</td>');
                    tr.append('<td>' + (r.status || '-') + '</td>');
                    $tbody.append(tr);
                });
            }

            let ordersChart = null;
            function renderTrend(trend) {
                const labels = trend.map(t => t.label || t.Label);
                const data = trend.map(t => t.orders ?? t.Orders);
                const ctx = document.getElementById('ordersTrendChart').getContext('2d');

                if (ordersChart) {
                    ordersChart.data.labels = labels;
                    ordersChart.data.datasets[0].data = data;
                    ordersChart.update();
                    return;
                }

                ordersChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Orders',
                            data: data,
                            backgroundColor: '#63B34E'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }

            function fetchAndRender() {
                const q = { from: $from.val(), to: $to.val(), status: $status.val() };
                $.getJSON(url, q).done(function (res) {
                    renderSummary(res.summary || res.Summary || []);
                    renderTable(res.orders || res.Orders || []);
                    renderTrend(res.trend || res.Trend || []);
                }).fail(function () {
                    alert('Failed to load report data');
                });
            }

            // allow client-side column sort by clicking headers
            $(document).on('click', '#ordersTable thead th', function () {
                const key = $(this).data('key');
                const $rows = $('#ordersTable tbody tr').get();
                const asc = !$(this).hasClass('asc');
                $rows.sort(function (a, b) {
                    const va = $(a).find('td').eq($(this).index()).text(); // not reliable by index; fallback to data-key sort via closure
                    return 0;
                }.bind(this));
                // Instead of complex column sorting logic here, re-fetch with server-side sort later.
                // For now just toggle visual state:
                $('#ordersTable thead th').removeClass('asc desc');
                $(this).addClass(asc ? 'asc' : 'desc');
            });

            $(function () {
                initDefaults();
                fetchAndRender();
                $('#applyFilters').on('click', fetchAndRender);
            });
        })();
    </script>
}
