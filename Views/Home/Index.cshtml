@{
    ViewData["Title"] = "NutriBite — Home";
    Layout = "~/Views/Shared/_PublicLayout.cshtml";
}

<link rel="stylesheet" href="~/css/home.css" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<header class="nb-nav shadow-sm">
  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container">
      
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nbNavbar" aria-controls="nbNavbar" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
  </nav>
</header>

<main>
  <!-- New modern hero -->
  <section class="nb-hero" role="region" aria-label="NutriBite hero">
    
    <div class="hero-inner">
      <div class="hero-copy fade-in">
        <div class="badge bg-success text-white px-3 py-1 mb-3" style="border-radius:999px; display:inline-block;">100% Homemade</div>
        <h1>Healthy Homemade Meals, Delivered Daily</h1>
        <p class="lead">Fresh, calorie-counted meals prepared by verified home chefs. Flexible subscriptions, daily deliveries and meals tailored to your needs.</p>
        <div class="cta d-flex gap-2">
          <a class="btn btn-success btn-lg" href="/Menu" role="button" aria-label="Order Now">Order Now</a>
          <a class="btn btn-outline-dark btn-lg" href="/Menu" role="button" aria-label="Explore Menu">Explore Menu</a>
        </div>

        <div class="mt-3 d-flex gap-3 align-items-center">
          
          <div class="d-flex gap-2 align-items-center">
            <img src="~/images/partners/partner1.png" alt="" style="height:28px; opacity:.9;" loading="lazy" />
            <img src="~/images/partners/partner2.png" alt="" style="height:28px; opacity:.9;" loading="lazy" />
          </div>
        </div>
      </div>

      <div class="hero-media fade-in delay" aria-hidden="true">
        <img src="~/images/hero/hero-food.png" alt="Fresh homemade meals" loading="lazy" />
      </div>
    </div>
  </section>

  <!-- Why choose us -->
  <section class="nb-why" aria-labelledby="whyChooseHeading">
    <div class="container">
      <div id="whyChooseHeading" class="special-header mb-4" role="heading" aria-level="2">
        <span>Why Choose NutriBite</span>
      </div>

      <div class="grid">
        <div class="card fade-in">
          <div class="icon green">🔥</div>
          <div>
            <h4>Calorie Counted</h4>
            <p>Clear nutritional info so you can track your intake without guesswork.</p>
          </div>
        </div>

        <div class="card fade-in">
          <div class="icon orange">🧼</div>
          <div>
            <h4>Hygienic Preparation</h4>
            <p>All meals prepared in verified kitchens following strict hygiene checks.</p>
          </div>
        </div>

        <div class="card fade-in">
          <div class="icon green">🥗</div>
          <div>
            <h4>Fresh Daily</h4>
            <p>Meals are cooked fresh every day and dispatched for same-day delivery.</p>
          </div>
        </div>

        <div class="card fade-in">
          <div class="icon orange">🏡</div>
          <div>
            <h4>No Restaurant Food</h4>
            <p>We partner with home chefs — authentic, homemade meals with love.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Preserve original site content below (hero removed to avoid duplicated image) -->
</main>

<!-- ORIGINAL CONTENT START - preserved (hero image section removed to prevent duplication) -->


    <!-- NEW: Hero Carousel (insert this BELOW the existing hero section) -->
    <section class="hero-carousel-wrap" aria-label="Showcase carousel">
        <div class="hero-carousel" data-interval="7000" tabindex="0">
            <div class="carousel-slides" role="list">
                <div class="carousel-slide active" role="listitem">
                    <img src="~/images/hero/slide%201.png" alt="Showcase 1" loading="lazy" />
                </div>
                <div class="carousel-slide" role="listitem">
                    <img src="~/images/hero/slide%202.png" alt="Showcase 2" loading="lazy" />
                </div>
                <div class="carousel-slide" role="listitem">
                    <img src="~/images/hero/slide%203.png" alt="Showcase 3" loading="lazy" />
                </div>
                <div class="carousel-slide" role="listitem">
                    <img src="~/images/hero/slide%204.png" alt="Showcase 4" loading="lazy" />
                </div>
                <div class="carousel-slide" role="listitem">
                    <img src="~/images/hero/slide%205.png" alt="Showcase 5" loading="lazy" />
                </div>
                <div class="carousel-slide" role="listitem">
                    <img src="~/images/hero/slide%206.png" alt="Showcase 6" loading="lazy" />
                </div>
            </div>

            <button class="carousel-nav carousel-prev" aria-label="Previous slide" type="button">&lsaquo;</button>
            <button class="carousel-nav carousel-next" aria-label="Next slide" type="button">&rsaquo;</button>

            <div class="carousel-dots" role="tablist" aria-label="Carousel indicators"></div>
        </div>
    </section>



<!-- HOW IT WORKS (new) -->
<section class="how-it-works py-5" aria-labelledby="howItWorksHeading">
    <div class="container text-center">
        <h3 id="howItWorksHeading">How NutriBite Works</h3>
        <p class="text-muted mb-4">Healthy meals in 4 simple steps</p>

        <div class="row g-3">
            <div class="col-sm-6 col-md-3">
                <div class="how-step card-soft">
                    <div class="step-icon">
                        <img src="images/icons/choose-meal.jpeg" alt="Choose Meal" class="icon-fix-1">
                    </div>
                    <div class="step-title">Choose Your Meal</div>
                </div>
            </div>

            <div class="col-sm-6 col-md-3">
                <div class="how-step card-soft">
                    <div class="step-icon">
                        <img src="images/icons/time-slot.jpeg" alt="Select Time">
                    </div>
                    <div class="step-title">Select Time Slot</div>
                </div>
            </div>

            <div class="col-sm-6 col-md-3">
                <div class="how-step card-soft">
                    <div class="step-icon">
                        <img src="images/icons/cal.jpeg" alt="Track Calories">
                    </div>
                    <div class="step-title">Track Your Calories</div>
                </div>
            </div>

            <div class="col-sm-6 col-md-3">
                <div class="how-step card-soft">
                    <div class="step-icon">
                        <img src="images/icons/fresh-meal.jpeg" alt="Fresh Homemade Food">
                    </div>
                    <div class="step-title">Enjoy Fresh Homemade Food</div>
                </div>
            </div>
        </div>
    </div>
</section>

   

    <!-- 2) Meal Categories / Meal Subscription Grid (comes AFTER Specially For You) -->
    <section class="meals-grid-section py-5" aria-labelledby="mealsGridHeading">
        <div class="meals-grid-header text-center mb-3">
            <h3 id="mealsGridHeading" class="m-0">Meal Categories</h3>
            <p class="text-muted small">Choose a meal plan or browse by category</p>
        </div>

        <div class="meals-grid" role="list">
            <a class="meal-card" role="listitem" href="/Meals/Category?name=StandardThali" aria-label="Standard Thali">
                <div class="meal-img-wrap">
                    <img src="~/images/meals/Standard_Thali.jpeg" alt="Standard Thali" class="meal-img" loading="lazy" />
                </div>
                <div class="meal-label">Standard Thali</div>
            </a>
            <a class="meal-card" role="listitem" href="/Meals/Category?name=SpecialThali" aria-label="Special Thali">
                <div class="meal-img-wrap">
                    <img src="~/images/meals/Special_Thali.jpeg" alt="Special Thali" class="meal-img" loading="lazy" />
                </div>
                <div class="meal-label">Special Thali</div>
            </a>

            <a class="meal-card" role="listitem" href="/Meals/Category?name=DeluxeThali" aria-label="Deluxe Thali">
                <div class="meal-img-wrap">
                    <img src="~/images/meals/Deluxe_Thali.jpeg" alt="Deluxe Thali" class="meal-img" loading="lazy" />
                </div>
                <div class="meal-label">Deluxe Thali</div>
            </a>

            <a class="meal-card" role="listitem" href="/Meals/Category?name=ClassicalThali" aria-label="Classical Thali">
                <div class="meal-img-wrap">
                    <img src="~/images/meals/Classical_Thali.jpeg" alt="Classical Thali" class="meal-img" loading="lazy" />
                </div>
                <div class="meal-label">Classical Thali</div>
            </a>
            <a class="meal-card" role="listitem" href="/Meals/Category?name=ComfortThali" aria-label="Comfort Thali">
                <div class="meal-img-wrap">
                    <img src="~/images/meals/Comfort_Thali.jpeg" alt="Comfort Thali" class="meal-img" loading="lazy" />
                </div>
                <div class="meal-label">Comfort Thali</div>
            </a>
            <a class="meal-card" role="listitem" href="/Meals/Category?name=Jain_Thali" aria-label="Jain Thali">
                <div class="meal-img-wrap">
                    <img src="~/images/meals/Jain_Thali.jpeg" alt="Jain Thali" class="meal-img" loading="lazy" />
                </div>
                <div class="meal-label">Jain Thali</div>
            </a>
            <a class="meal-card" role="listitem" href="/Meals/Category?name=RiceCombo" aria-label="Rice Combo">
                <div class="meal-img-wrap">
                    <img src="~/images/meals/Rice_Combo.jpeg" alt="Rice Combo" class="meal-img" loading="lazy" />
                </div>
                <div class="meal-label">Rice Combo</div>
            </a>
            <a class="meal-card" role="listitem" href="/Meals/Category?name=LowCalorie" aria-label="Low Calorie">
                <div class="meal-img-wrap">
                    <img src="~/images/meals/low-calorie.jpg" alt="Low Calorie" class="meal-img" loading="lazy" />
                </div>
                <div class="meal-label">Low Calorie</div>
            </a>
            <a class="meal-card" role="listitem" href="/Meals/Category?name=ProteinMeal" aria-label="Protein Meal">
                <div class="meal-img-wrap">
                    <img src="~/images/meals/protein.jpg" alt="Protein Meal" class="meal-img" loading="lazy" />
                </div>
                <div class="meal-label">Protein Meal</div>
            </a>

            <a class="meal-card" role="listitem" href="/Meals/Category?name=SaladBowl" aria-label="Salad Bowl">
                <div class="meal-img-wrap">
                    <img src="~/images/meals/salads.jpeg" alt="Salad Bowl" class="meal-img" loading="lazy" />
                </div>
                <div class="meal-label">Salad Bowl</div>
            </a>
        </div>
    </section>

    <!-- NEW: Food Categories (insert above "Specially For You") -->
    <section class="food-categories py-5" aria-labelledby="foodCategoriesHeading">
        <div class="container">
            <div id="foodCategoriesHeading" class="special-header mb-4" role="heading" aria-level="2">
                <span>Food Categories</span>
            </div>

            <div class="special-grid" role="list">
                <!-- Veg -->
                <div class="category-card" role="listitem" aria-label="Veg">
                    <div class="category-imgwrap">
                        <img src="~/images/Product/Veg.jpeg" alt="Veg" class="category-img" loading="lazy" />
                    </div>
                    <div class="category-body">
                        <a class="category-btn" href="/Meals/Category?name=Veg" role="button">Veg</a>
                    </div>
                </div>

                <!-- Non-Veg -->
                <div class="category-card" role="listitem" aria-label="Non-Veg">
                    <div class="category-imgwrap">
                        <img src="~/images/Product/Nonveg.jpeg" alt="Non-Veg" class="category-img" loading="lazy" />
                    </div>
                    <div class="category-body">
                        <a class="category-btn" href="/Meals/Category?name=NonVeg" role="button">Non-Veg</a>
                    </div>
                </div>

                <!-- Eggitarian -->
                <div class="category-card" role="listitem" aria-label="Eggitarian">
                    <div class="category-imgwrap">
                        <img src="~/images/Product/Eggitarian.jpeg" alt="Eggitarian" class="category-img" loading="lazy" />
                    </div>
                    <div class="category-body">
                        <a class="category-btn" href="/Meals/Category?name=Eggitarian" role="button">Eggitarian</a>
                    </div>
                </div>

                <!-- Jain -->
                <div class="category-card" role="listitem" aria-label="Jain">
                    <div class="category-imgwrap">
                        <img src="~/images/Product/JainFood.jpeg" alt="Jain" class="category-img" loading="lazy" />
                    </div>
                    <div class="category-body">
                        <a class="category-btn" href="/Meals/Category?name=Jain" role="button">Jain</a>
                    </div>
                </div>

                <!-- Vegan -->
                <div class="category-card" role="listitem" aria-label="Vegan">
                    <div class="category-imgwrap">
                        <img src="~/images/Product/Vegan.jpeg" alt="Vegan" class="category-img" loading="lazy" />
                    </div>
                    <div class="category-body">
                        <a class="category-btn" href="/Meals/Category?name=Vegan" role="button">Vegan</a>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- End food categories -->

    <!-- 1) SPECIALLY FOR YOU (Students, Elderly, Corporate) -->
    <section class="specially-for-you py-5" aria-labelledby="specialForYouHeading">
        <div class="container">
            <div id="specialForYouHeading" class="special-header mb-4" role="heading" aria-level="2">
                <span>SPECIALLY FOR YOU</span>
            </div>

            <div class="special-grid" role="list">
                <!-- Student -->
                <div class="category-card" role="listitem" aria-label="Students">
                    <div class="category-imgwrap">
                        <img src="~/images/categories/student.jpeg" alt="Students meal" class="category-img" loading="lazy" />
                    </div>
                    <div class="category-body">
                        <button type="button" class="category-btn" aria-label="Students category">STUDENTS</button>
                    </div>
                </div>

                <!-- Elderly -->
                <div class="category-card" role="listitem" aria-label="Elderly">
                    <div class="category-imgwrap">
                        <img src="~/images/categories/elderly.jpeg" alt="Elderly meal" class="category-img" loading="lazy" />
                    </div>
                    <div class="category-body">
                        <button type="button" class="category-btn" aria-label="Elderly category">ELDERLY</button>
                    </div>
                </div>

                <!-- Corporate -->
                <div class="category-card" role="listitem" aria-label="Corporate">
                    <div class="category-imgwrap">
                        <img src="~/images/categories/corporate.jpeg" alt="Corporate meal" class="category-img" loading="lazy" />
                    </div>
                    <div class="category-body">
                        <button type="button" class="category-btn" aria-label="Corporate category">CORPORATE</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    

    <!-- FAQ (new) -->
    <section class="faq-section py-5" aria-labelledby="faqHeading">
        <div class="container">
            <h3 id="faqHeading">Frequently Asked Questions</h3>
            <div class="accordion mt-3" id="faqAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="faqOne">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                            Is the food really homemade?
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="faqOne" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Yes — every meal is prepared by verified home chefs; we do not serve restaurant food.
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="faqTwo">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            How do you calculate calories?
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="faqTwo" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Our chefs follow standard portioning and use calorie databases to label meals accurately.
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="faqThree">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                            Do you deliver daily?
                        </button>
                    </h2>
                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="faqThree" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Yes — we deliver daily across our service areas (check delivery availability during checkout).
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header" id="faqFour">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                            Is Jain food prepared separately?
                        </button>
                    </h2>
                    <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="faqFour" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Yes — Jain meals follow separate preparation guidelines to avoid root vegetables, and we ensure separation where required.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="mt-4">
        <h4>Categories</h4>
        <div id="categories" class="categories" aria-label="Food categories"></div>
    </section>

    <section class="mt-3" id="foodsSection">
        <div class="d-flex align-items-center justify-content-between mb-2">
            <h4 id="foodsHeading" class="m-0">Foods</h4>

            <!-- Meal slot selector -->
            <div class="slot-selector" role="tablist" aria-label="Select meal slot">
                <button type="button" class="slot-btn active" data-slot="Breakfast">Breakfast</button>
                <button type="button" class="slot-btn" data-slot="Lunch">Lunch</button>
                <button type="button" class="slot-btn" data-slot="Dinner">Dinner</button>
                <button type="button" class="slot-btn" data-slot="Snacks">Snacks</button>
            </div>
        </div>

        <div id="loading" class="mt-2" style="display:none;">Loading…</div>
        <div id="noResults" class="mt-2 text-muted" style="display:none;">No foods found for this category.</div>

        <div class="d-lg-flex gap-3">
            <div id="foodGrid" class="food-grid mt-3 flex-grow-1" aria-live="polite"></div>

            <!-- Daily calorie summary panel (hidden on small screens) -->
            <aside id="dailyPanel" class="daily-panel d-none d-lg-block">
                <div class="panel-header">
                    <strong>Today's Meals</strong>
                    <small class="text-muted ms-1" id="panelDate"></small>
                </div>
                <div class="panel-body">
                    <div class="panel-empty text-center text-muted">
                        <div>Sign in to save & track your meals.</div>
                        <div class="mt-2">
                            <button id="panelLoginBtn" class="btn btn-cta btn-sm">Login</button>
                        </div>
                    </div>
                </div>

                <div class="panel-footer">
                    <div class="totals">
                        <div>Total: <span class="totalCalories">0</span> kcal</div>
                        <div>Goal: <span class="calorieGoal">—</span></div>
                        <div>Remaining: <span class="remainingCalories">—</span></div>
                    </div>
                </div>
            </aside>
        </div>
    </section>
</div>

<!-- snackbar / toast -->
<div id="snackbar" class="snackbar" aria-live="polite" aria-atomic="true" hidden></div>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script>
        /**
         * Geolocation request on page load (HTML5 Geolocation API)
         *
         * - Triggers the browser's permission prompt automatically on DOMContentLoaded.
         * - Stores latitude/longitude in localStorage as 'user_latitude' and 'user_longitude' on success.
         * - Logs location to console for debugging.
         * - Shows fallback alerts on denial, timeout, unavailable or unsupported browsers.
         *
         * Notes:
         * - No backend calls, non-blocking, minimal and self-contained.
         * - Works on Chrome, Edge and modern mobile browsers supporting navigator.geolocation.
         */
        (function () {
            // Run as soon as DOM is ready
            window.addEventListener('DOMContentLoaded', function () {
                try {
                    // Feature detection
                    if (!('geolocation' in navigator)) {
                        // Browser does not support geolocation
                        alert('Geolocation is not supported by your browser.');
                        return;
                    }

                    // Request current position; this triggers the browser permission popup.
                    navigator.geolocation.getCurrentPosition(
                        function success(position) {
                            // Successfully obtained position
                            var lat = position.coords.latitude;
                            var lon = position.coords.longitude;

                            // Store values in localStorage for later use
                            try {
                                localStorage.setItem('user_latitude', String(lat));
                                localStorage.setItem('user_longitude', String(lon));
                            } catch (storageErr) {
                                // Storage may be unavailable in some privacy modes; just log
                                console.warn('Unable to store location in localStorage', storageErr);
                            }

                            // Log for debugging (do not leak to external systems)
                            console.log('Geolocation success:', { latitude: lat, longitude: lon });
                        },
                        function error(err) {
                            // Handle errors gracefully with user-friendly messages
                            // err.code: 1=PERMISSION_DENIED, 2=POSITION_UNAVAILABLE, 3=TIMEOUT
                            switch (err.code) {
                                case 1:
                                    alert('Location permission denied. Some features may be limited.');
                                    break;
                                case 2:
                                    alert('Unable to determine your location. Please try again later.');
                                    break;
                                case 3:
                                    alert('Location request timed out. Try again.');
                                    break;
                                default:
                                    alert('Unable to obtain your location.');
                                    break;
                            }
                            console.warn('Geolocation error', err);
                        },
                        {
                            // Options: non-blocking, reasonable timeout
                            enableHighAccuracy: false,
                            timeout: 8000,       // 8 seconds
                            maximumAge: 10 * 60 * 1000 // accept cached position up to 10 minutes
                        }
                    );
                } catch (ex) {
                    // Unexpected error — log silently and fail gracefully
                    console.error('Geolocation initialization failed', ex);
                }
            }, { passive: true });
        })();
    </script>

    <script>
        (function () {
            const categories = ["All", "Breakfast", "Lunch", "Dinner", "Snacks", "Drinks"];
            const $cats = $('#categories');
            const $grid = $('#foodGrid');
            const $loading = $('#loading');
            const $no = $('#noResults');
            const $sn = $('#snackbar');
            const $panel = $('#dailyPanel');

            let selectedSlot = 'Breakfast';

            function showSnack(msg) {
                $sn.text(msg).attr('hidden', null).addClass('show');
                setTimeout(() => { $sn.removeClass('show'); setTimeout(()=> $sn.attr('hidden', 'hidden'), 300); }, 2200);
            }

            function renderCategoryTiles() {
                $cats.empty();
                categories.forEach((c, idx) => {
                    const tile = $('<div>').addClass('cat-tile').attr('data-cat', c).attr('role','button').attr('tabindex',0).text(c);
                    if (idx === 0) tile.addClass('active');
                    $cats.append(tile);
                });
            }

            function buildCard(f) {
                const id = f.id || f.Id;
                const name = f.name || f.Name || '';
                const desc = f.description || f.Description || '';
                const img = f.image || f.Image || '/images/placeholder.png';
                const calories = (f.calories || f.Calories || f.cal || '').toString();
                const diet = (f.diet || f.Diet || f.dietTag || '').toString();

                const card = $('<div>').addClass('food-card').attr('data-id', id);

                const imgWrap = $('<div>').addClass('food-img-wrap');
                imgWrap.append($('<img>').attr('src', img).attr('alt', name));

                if (diet) imgWrap.append($('<span>').addClass('diet-tag').text(diet));
                if (calories) imgWrap.append($('<span>').addClass('cal-badge').text(calories + ' kcal'));

                // favorite button
                const fav = $('<button>').addClass('fav-btn').attr('type','button').attr('aria-pressed','false').attr('data-id', id)
                    .html('<svg class="fav-icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false"><path fill="currentColor" d="M12 21s-7.5-4.5-10-7.4C-1 8.4 4.2 3 8.6 5.3 10.8 6.6 12 9 12 9s1.2-2.4 3.4-3.7C19.8 3 25 8.4 22 13.6 19.5 16.5 12 21 12 21z"/></svg>');
                imgWrap.append(fav);

                card.append(imgWrap);
                card.append($('<strong>').addClass('food-title').text(name));
                if (desc) card.append($('<div>').addClass('meta').text(desc));

                const btnRow = $('<div>').addClass('btn-row');
                btnRow.append($('<a>').addClass('btn-primary-ghost').attr('href', '/Food/Details/' + id).text('View Details'));

                const addBtn = $('<button>').addClass('btn-cta add-btn').attr('data-id', id).attr('type','button');
                addBtn.append($('<span>').addClass('btn-label').text('Add'));
                addBtn.append($('<span>').addClass('btn-spinner').hide().html('&nbsp;<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>'));
                addBtn.append($('<span>').addClass('btn-success').hide().text('✓ Added'));
                btnRow.append(addBtn);

                card.append(btnRow);
                return card;
            }

            function fetchFoods(category) {
                $loading.show();
                $no.hide();
                $grid.empty();

                $.getJSON('/Foods/GetFoods', { category: category === 'All' ? '' : category })
                    .done(function (list) {
                        $loading.hide();
                        if (!list || list.length === 0) {
                            $no.show();
                            return;
                        }

                        list.forEach(f => { $grid.append(buildCard(f)); });

                        // refresh daily panel and favorites state after rendering cards
                        loadDailyPanel();
                        $.getJSON('/Auth/IsAuthenticated').done(function (au) {
                            if (au && au.authenticated) {
                                $.getJSON('/Favorites/UserFavorites').done(function (res) {
                                    if (res && res.ids) {
                                        const ids = new Set(res.ids.map(x => Number(x)));
                                        $grid.find('.fav-btn').each(function () {
                                            const fid = Number($(this).data('id'));
                                            if (ids.has(fid)) $(this).addClass('active').attr('aria-pressed', 'true').attr('title','Remove from favorites');
                                        });
                                    }
                                });
                            }
                        });
                    })
                    .fail(function () {
                        $loading.hide();
                        $no.html('<div class="empty-card"><div class="empty-icon">🍽️</div><div class="empty-title">Unable to load foods</div><div class="empty-desc text-muted">Please check your connection or try again.</div><div class="mt-2"><button class="retry-btn btn btn-outline-success btn-sm">Retry</button></div></div>').show();
                    });
            }

            // retry button handler for empty state (keeps existing fetch logic)
            $(document).on('click', '#noResults .retry-btn', function () {
                const cat = $('#categories .cat-tile.active').data('cat') || 'All';
                fetchFoods(cat);
            });

            // daily panel rendering
            function renderPanel(data) {
                $('#panelDate').text(data.date || '');
                const $body = $panel.find('.panel-body');
                if (!data.authenticated) {
                    $body.html('<div class="panel-empty text-center text-muted"><div>Sign in to save & track your meals.</div><div class="mt-2"><button id="panelLoginBtn" class="btn btn-cta btn-sm">Login</button></div></div>');
                    $panel.find('.totalCalories').text('0');
                    $panel.find('.calorieGoal').text('—');
                    $panel.find('.remainingCalories').text('—');
                    $body.find('#panelLoginBtn').on('click', function () { if (typeof showAuthModal === 'function') showAuthModal('login'); });
                    return;
                }

                const meals = data.meals || [];
                if (!meals.length) {
                    $body.html('<div class="panel-empty text-center text-muted">No meals added for today.</div>');
                } else {
                    let html = '<div class="daily-list">';
                    // group by slot
                    const groups = {};
                    meals.forEach(m => {
                        const s = (m.slot || 'Other');
                        groups[s] = groups[s] || [];
                        groups[s].push(m);
                    });
                    const slotOrder = ['Breakfast','Lunch','Dinner','Snacks'];
                    slotOrder.forEach(slot => {
                        if (!groups[slot]) return;
                        html += `<div class="slot-block"><div class="slot-title">${slot}</div>`;
                        groups[slot].forEach(m => {
                            html += `<div class="meal-row"><div class="meal-left"><div class="meal-name">${(m.name||'')}</div><div class="meal-meta text-muted">${(m.calories||0)} kcal</div></div></div>`;
                        });
                        html += '</div>';
                    });

                    // any other slots
                    Object.keys(groups).forEach(k => {
                        if (slotOrder.includes(k)) return;
                        html += `<div class="slot-block"><div class="slot-title">${k}</div>`;
                        groups[k].forEach(m => {
                            html += `<div class="meal-row"><div class="meal-left"><div class="meal-name">${(m.name||'')}</div><div class="meal-meta text-muted">${(m.calories||0)} kcal</div></div></div>`;
                        });
                        html += '</div>';
                    });

                    html += '</div>';
                    $body.html(html);
                }

                $panel.find('.totalCalories').text((data.totalCalories ?? 0));
                $panel.find('.calorieGoal').text(data.calorieGoal ?? '—');
                $panel.find('.remainingCalories').text((data.remaining !== null && data.remaining !== undefined) ? data.remaining : '—');
            }

            function loadDailyPanel() {
                $.getJSON('/Meals/Today').done(function (res) {
                    renderPanel(res || { authenticated: false });
                }).fail(function () {
                    // keep existing content
                });
            }

            // slot selector
            $(document).on('click', '.slot-btn', function () {
                $('.slot-btn').removeClass('active');
                $(this).addClass('active');
                selectedSlot = $(this).data('slot');
                showSnack('Selected ' + selectedSlot);
            });

            // favorite toggle
            $(document).on('click', '.fav-btn', function (e) {
                e.stopPropagation();
                const $btn = $(this);
                if ($btn.hasClass('processing')) return;
                const id = $btn.data('id');

                $.getJSON('/Auth/IsAuthenticated').done(function (res) {
                    if (!(res && res.authenticated)) {
                        // preserve intent, then open login modal
                        if (window.setPendingAction) window.setPendingAction({ type: 'toggleFavorite', foodId: id });
                        if (typeof showAuthModal === 'function') showAuthModal('login');
                        else { var mp = document.getElementById('loginPrompt'); if (mp) new bootstrap.Modal(mp).show(); }
                        return;
                    }

                    const wasActive = $btn.hasClass('active');
                    $btn.addClass('processing').prop('disabled', true).toggleClass('active');

                    $.post('/Favorites/Toggle', { foodId: id })
                        .done(function (resp) {
                            if (resp && resp.success) {
                                const fav = !!resp.favorited;
                                $btn.toggleClass('active', fav).attr('aria-pressed', String(fav));
                                $btn.attr('title', fav ? 'Remove from favorites' : 'Add to favorites');
                                showSnack(fav ? 'Added to favorites' : 'Removed from favorites');
                            } else {
                                $btn.toggleClass('active', wasActive).attr('aria-pressed', String(wasActive));
                                alert(resp && resp.message ? resp.message : 'Unable to update favorites.');
                            }
                        })
                        .fail(function () {
                            $btn.toggleClass('active', wasActive).attr('aria-pressed', String(wasActive));
                            alert('Unable to update favorites.');
                        })
                        .always(function () { $btn.removeClass('processing').prop('disabled', false); });
                }).fail(function () { alert('Unable to verify authentication status.'); });
            });

            // Add -> Meals flow (date-wise, slot-aware)
            $(document).on('click', '.add-btn', function () {
                const $btn = $(this);
                if ($btn.data('processing')) return;

                const id = $btn.data('id');

                $.getJSON('/Auth/IsAuthenticated').done(function (res) {
                    if (!(res && res.authenticated)) {
                        // preserve intent then open modal
                        if (window.setPendingAction) window.setPendingAction({ type: 'addMeal', foodId: id, slot: selectedSlot });
                        if (typeof showAuthModal === 'function') showAuthModal('login');
                        else { var mp = document.getElementById('loginPrompt'); if (mp) new bootstrap.Modal(mp).show(); }
                        return;
                    }

                    // show spinner
                    $btn.data('processing', true);
                    $btn.find('.btn-label').hide();
                    $btn.find('.btn-spinner').show();
                    $btn.prop('disabled', true);

                    $.post('/Meals/Add', { foodId: id, slot: selectedSlot })
                        .done(function (resp) {
                            if (resp && resp.success) {
                                if (resp.added) {
                                    const $card = $btn.closest('.food-card');
                                    $card.addClass('added');
                                    setTimeout(()=> $card.removeClass('added'), 650);
                                    showSnack('Added to ' + (resp.slot || selectedSlot));
                                    // refresh panel
                                    loadDailyPanel();
                                } else {
                                    showSnack(resp.message || 'Already added to that slot today.');
                                }
                            } else {
                                alert(resp && resp.message ? resp.message : 'Unable to add meal.');
                            }
                        })
                        .fail(function () {
                            alert('Unable to add meal. Try again.');
                        })
                        .always(function () {
                            $btn.find('.btn-spinner').hide();
                            $btn.find('.btn-success').show();
                            setTimeout(function () {
                                $btn.find('.btn-success').hide();
                                $btn.find('.btn-label').show();
                                $btn.prop('disabled', false);
                                $btn.data('processing', false);
                            }, 1100);
                        });
                }).fail(function () { alert('Unable to verify authentication status.'); });
            });

            // Listen for replayed pending actions (triggered by layout when user logs in)
            document.addEventListener('pendingAction:done', function (e) {
                const d = e.detail || {};
                if (!d.type) return;
                if (d.type === 'addMeal') {
                    const fid = d.params && d.params.foodId;
                    // reflect same UI as manual add success
                    const $card = $grid.find('.food-card[data-id="' + fid + '"]');
                    if ($card.length) {
                        $card.addClass('added');
                        setTimeout(()=> $card.removeClass('added'), 650);
                    }
                    showSnack('Added to ' + (d.resp && (d.resp.slot || d.params.slot)) );
                    // refresh panel
                    loadDailyPanel();
                } else if (d.type === 'toggleFavorite') {
                    const fid = d.params && d.params.foodId;
                    const favResp = d.resp || {};
                    const $btn = $grid.find('.fav-btn[data-id="' + fid + '"]');
                    if ($btn.length && favResp.success) {
                        const fav = !!favResp.favorited;
                        $btn.toggleClass('active', fav).attr('aria-pressed', String(fav));
                    }
                    if (d.resp && d.resp.success) showSnack((d.resp.favorited ? 'Added to favorites' : 'Removed from favorites'));
                } else if (d.type === 'addToCart') {
                    // fallback: if AJAX add succeeded, show confirmation
                    if (d.resp && d.resp.success) showSnack('Added to cart');
                }
            });

            // category click
            $cats.on('click keypress', '.cat-tile', function (e) {
                if (e.type === 'keypress' && e.which !== 13 && e.which !== 32) return;
                $cats.find('.cat-tile').removeClass('active');
                $(this).addClass('active');
                const cat = $(this).data('cat');
                fetchFoods(cat);
                const top = $('#foodsHeading').offset().top - 80;
                $('html,body').animate({ scrollTop: top }, 420);
            });

            $('#exploreBtn').on('click', function () {
                $('html,body').animate({ scrollTop: $('#foodsHeading').offset().top - 80 }, 500);
                fetchFoods('All');
            });

            // refresh panel when user logs in
            document.addEventListener('user:login', function () { loadDailyPanel(); });

            // periodic refresh
            setInterval(loadDailyPanel, 30000);

            $(function () { renderCategoryTiles(); fetchFoods('All'); loadDailyPanel(); });
        })();
    </script>

    <!-- Lightweight vanilla JS for trust counters & subtle hero animation trigger -->
    <script>
        (function () {
            // simple fade-in hero text on load
            document.addEventListener('DOMContentLoaded', function () {
                var hero = document.querySelector('.hero-enhanced');
                if (hero) hero.classList.add('in-view');
            });

            // count-up animation for metrics (vanilla)
            function animateValue(el, start, end, duration, decimals) {
                var startTime = null;
                decimals = decimals || 0;
                function step(timestamp) {
                    if (!startTime) startTime = timestamp;
                    var progress = Math.min((timestamp - startTime) / duration, 1);
                    var value = start + (end - start) * progress;
                    el.textContent = decimals ? value.toFixed(decimals) : Math.floor(value);
                    if (progress < 1) {
                        requestAnimationFrame(step);
                    } else {
                        // final value (format may differ for rating)
                        el.textContent = decimals ? end.toFixed(decimals) : (end % 1 === 0 ? String(end) : String(end));
                    }
                }
                requestAnimationFrame(step);
            }

            // start counters when visible
            var metrics = document.querySelectorAll('.trust-metrics-strip .count');
            if ('IntersectionObserver' in window && metrics.length) {
                var obs = new IntersectionObserver(function (entries, o) {
                    entries.forEach(function (entry) {
                        if (entry.isIntersecting) {
                            var el = entry.target;
                            var t = el.getAttribute('data-target');
                            var val = parseFloat(t);
                            if (t.indexOf('.') >= 0) {
                                animateValue(el, 0, val, 1400, 1);
                            } else {
                                animateValue(el, 0, val, 1400, 0);
                            }
                            o.unobserve(el);
                        }
                    });
                }, { threshold: 0.4 });
                metrics.forEach(function (m) { obs.observe(m); });
            } else {
                // fallback: animate immediately
                metrics.forEach(function (m) {
                    var t = m.getAttribute('data-target');
                    var val = parseFloat(t);
                    if (t.indexOf('.') >= 0) animateValue(m, 0, val, 1400, 1);
                    else animateValue(m, 0, val, 1400, 0);
                });
            }
        })();
    </script>

    <script>
(function(){
  const root = document.querySelector('.hero-carousel');
  if (!root) return;

  // helper
  const q = (sel, el = root) => el.querySelector(sel);
  const qs = (sel, el = root) => Array.from(el.querySelectorAll(sel));

  // preload images (non-blocking)
  qs('.carousel-slide img', root).forEach(img => {
    const src = img.getAttribute('src');
    if (!src) return;
    const i = new Image();
    i.src = src;
  });

  const slides = qs('.carousel-slide', root);
  const dotsWrap = q('.carousel-dots');
  const prevBtn = q('.carousel-prev');
  const nextBtn = q('.carousel-next');
  let current = slides.findIndex(s => s.classList.contains('active'));
  if (current < 0) current = 0;
  // build dots if none
  if (dotsWrap && dotsWrap.children.length === 0) {
    slides.forEach((s, idx) => {
      const b = document.createElement('button');
      b.type = 'button';
      b.dataset.index = idx;
      if (idx === current) b.classList.add('active');
      dotsWrap.appendChild(b);
    });
  }
  const dots = qs('button', dotsWrap || document.createElement('div'));

  // show slide
  function show(idx, immediate) {
    idx = (idx + slides.length) % slides.length;
    if (idx === current && !immediate) return;
    slides.forEach((s,i) => s.classList.toggle('active', i === idx));
    dots.forEach((d,i) => d.classList.toggle('active', i === idx));
    current = idx;
  }

  // auto-play control (IntersectionObserver controlled in your original script)
  let intervalMs = parseInt(root.getAttribute('data-interval')) || 7000;
  let timer = null;
  let paused = false;
  function startAuto(){ stopAuto(); timer = setInterval(()=> { if(!paused) show(current+1); }, intervalMs); }
  function stopAuto(){ if(timer){ clearInterval(timer); timer = null; } }

  // navigation
  nextBtn?.addEventListener('click', e=> { e.preventDefault(); show(current+1); startAuto(); });
  prevBtn?.addEventListener('click', e=> { e.preventDefault(); show(current-1); startAuto(); });
  dots.forEach(d => d.addEventListener('click', e => { show(Number(d.dataset.index)); startAuto(); }));

  // swipe / pointer support
  let startX = 0, startY = 0, dx = 0, dy = 0, dragging = false, moved = false;
  const THRESH = 50; // px to register swipe
  const MAX_VERTICAL_DRIFT = 30; // allow slight vertical movement

  function onTouchStart(e){
    const t = e.touches ? e.touches[0] : e;
    startX = t.clientX; startY = t.clientY; dx = 0; dy = 0; dragging = true; moved = false;
    root.classList.add('dragging');
  }
  function onTouchMove(e){
    if (!dragging) return;
    const t = e.touches ? e.touches[0] : e;
    dx = t.clientX - startX; dy = t.clientY - startY;
    // if predominantly horizontal, prevent vertical scrolling to improve gesture
    if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 10) {
      e.preventDefault && e.preventDefault();
      moved = true;
    }
  }
  function onTouchEnd(e){
    root.classList.remove('dragging');
    dragging = false;
    if (!moved) return;
    if (Math.abs(dy) > MAX_VERTICAL_DRIFT && Math.abs(dy) > Math.abs(dx)) return; // it's vertical scroll
    if (dx > THRESH) { show(current - 1); startAuto(); }
    else if (dx < -THRESH) { show(current + 1); startAuto(); }
  }

  // attach both touch and pointer events for cross-browser
  root.addEventListener('touchstart', onTouchStart, { passive: false });
  root.addEventListener('touchmove', onTouchMove, { passive: false });
  root.addEventListener('touchend', onTouchEnd);
  // pointer events for desktop drag
  root.addEventListener('pointerdown', function(e){
    if (e.pointerType === 'mouse') return; // ignore mouse drag, keep click
    onTouchStart(e);
  }, { passive: true });
  root.addEventListener('pointermove', function(e){
    if (e.pointerType === 'mouse') return;
    onTouchMove(e);
  }, { passive: false });
  root.addEventListener('pointerup', function(e){
    if (e.pointerType === 'mouse') return;
    onTouchEnd(e);
  });

  // pause on hover/focus (keep existing behavior)
  root.addEventListener('mouseenter', ()=> paused = true);
  root.addEventListener('mouseleave', ()=> paused = false);
  root.addEventListener('focusin', ()=> paused = true);
  root.addEventListener('focusout', ()=> paused = false);

  // Respect reduced motion — if user prefers reduced motion, disable auto-play
  if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
    stopAuto();
  } else {
    // only start auto when carousel becomes visible (if you already use IntersectionObserver elsewhere this is compatible)
    if ('IntersectionObserver' in window) {
      const io = new IntersectionObserver(entries => {
        entries.forEach(en => {
          if (en.isIntersecting) startAuto(); else stopAuto();
        });
      }, { threshold: 0.5 });
      io.observe(root);
    } else startAuto();
  }

  // ensure first slide visible immediately
  show(current, true);

  // debug helper - log 404s for images
  qs('.carousel-slide img', root).forEach(img => {
    img.addEventListener('error', () => console.warn('Carousel image failed to load:', img.getAttribute('src')));
  });
})();

    </script>
}