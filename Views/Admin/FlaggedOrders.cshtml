@{
    ViewData["Title"] = "Flagged Orders";
}

@Html.AntiForgeryToken()

<div class="table-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Flagged / Suspicious Orders</h3>
        <div>
            <button id="refreshBtn" class="btn btn-sm btn-outline-secondary">Refresh</button>
            <span id="lastUpdated" class="ms-3 text-muted"></span>
        </div>
    </div>

    <p class="text-muted">Review flagged orders (possible duplicates, COD risk, unusual activity). Resolve or escalate as needed.</p>

    <div class="table-responsive">
        <table class="table admin-table" id="flaggedTable">
            <thead>
                <tr>
                    <th>Order Id</th>
                    <th>Flag Reason</th>
                    <th>Customer</th>
                    <th>Order Value</th>
                    <th>Calories</th>
                    <th>Flagged At</th>
                    <th>Resolved</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- rows populated by script -->
            </tbody>
        </table>
    </div>

    <div id="noFlagged" class="no-records" style="display:none;">No flagged orders.</div>
</div>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>

    <script>
        (function ($) {
            const token = $('input[name="__RequestVerificationToken"]').first().val();

            function formatStatusResolved(isResolved) {
                if (isResolved) return '<span class="badge bg-success">Resolved</span>';
                return '<span class="badge bg-warning text-dark">Unresolved</span>';
            }

            function formatBadge(status) {
                // simple reuse of visual mapping from site.css
                const clsMap = {
                    "New": "status-new",
                    "Accepted": "status-accepted",
                    "Ready for Pickup": "status-ready",
                    "Picked": "status-picked",
                    "Flagged": "status-flagged",
                    "Cancelled": "status-cancelled"
                };
                const cls = clsMap[status] || "status-unknown";
                return '<span class="order-status-badge ' + cls + '">' + (status || '-') + '</span>';
            }

            function renderRows(list) {
                const $tbody = $('#flaggedTable tbody').empty();
                if (!list || list.length === 0) {
                    $('#noFlagged').show();
                    $('#flaggedTable').hide();
                    return;
                }
                $('#noFlagged').hide();
                $('#flaggedTable').show();

                list.forEach(o => {
                    const orderLink = '<a href="/Admin/OrderDetails?orderId=' + o.OrderId + '">#' + o.OrderId + '</a>';
                    const customer = (o.CustomerName || '-') + '<br/><small class="text-muted">' + (o.CustomerPhone || '-') + '</small>';
                    const amount = '₹' + (o.Amount ?? 0).toFixed(2);
                    const calories = o.TotalCalories ?? 0;
                    const flaggedAt = o.CreatedAt ? new Date(o.CreatedAt).toLocaleString() : '-';

                    const $tr = $('<tr>').attr('data-id', o.OrderId);
                    $tr.append($('<td>').html(orderLink));
                    $tr.append($('<td>').text(o.FlagReason || 'Suspicious'));
                    $tr.append($('<td>').html(customer));
                    $tr.append($('<td>').html(amount));
                    $tr.append($('<td>').text(calories));
                    $tr.append($('<td>').text(flaggedAt));
                    $tr.append($('<td>').html(formatStatusResolved(o.IsResolved)));
                    // Actions: Verify (approve), Cancel, Block Customer
                    const verifyBtn = '<button class="btn btn-sm btn-approve verify-btn" data-id="' + o.OrderId + '">Verify & Approve</button>';
                    const cancelBtn = '<button class="btn btn-sm btn-reject cancel-btn ms-1" data-id="' + o.OrderId + '">Cancel</button>';
                    const blockBtn = '<button class="btn btn-sm btn-outline-danger block-btn ms-1" data-phone="' + (o.CustomerPhone || '') + '">Block Customer</button>';

                    $tr.append($('<td>').html(verifyBtn + cancelBtn + blockBtn));
                    $tbody.append($tr);
                });

                $('#lastUpdated').text('Updated: ' + new Date().toLocaleTimeString());
            }

            function fetchFlagged() {
                $.ajax({
                    url: '/Admin/GetFlaggedOrders',
                    method: 'GET',
                    dataType: 'json'
                }).done(function (data) {
                    renderRows(data);
                }).fail(function () {
                    alert('Failed to load flagged orders.');
                });
            }

            function postAction(url, payload, onDone) {
                payload.__RequestVerificationToken = token;
                $.post({
                    url: url,
                    data: payload,
                    dataType: 'json'
                }).done(function (res) {
                    if (res && res.success) {
                        onDone && onDone(res);
                        $(document).trigger('orders:refresh');
                    } else {
                        alert(res?.message || 'Action failed');
                    }
                }).fail(function () {
                    alert('Server error');
                });
            }

            // Delegated action handlers
            $(document).on('click', '.verify-btn', function () {
                const id = $(this).data('id');
                if (!confirm('Approve this flag and clear it for the order #' + id + '?')) return;
                postAction('/Admin/VerifyFlag', { orderId: id }, function () {
                    fetchFlagged();
                });
            });

            $(document).on('click', '.cancel-btn', function () {
                const id = $(this).data('id');
                if (!confirm('Cancel order #' + id + '?')) return;
                postAction('/Admin/CancelOrder', { orderId: id }, function () {
                    fetchFlagged();
                });
            });

            $(document).on('click', '.block-btn', function () {
                const phone = $(this).data('phone');
                if (!phone) { alert('Customer phone not available'); return; }
                if (!confirm('Block customer ' + phone + ' ?')) return;
                postAction('/Admin/BlockCustomer', { customerPhone: phone }, function () {
                    fetchFlagged();
                });
            });

            $('#refreshBtn').on('click', fetchFlagged);

            // initial load
            $(function () {
                fetchFlagged();
            });

        })(jQuery);
    </script>
}
