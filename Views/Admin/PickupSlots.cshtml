@{
    ViewData["Title"] = "Pickup Slots";
}

@Html.AntiForgeryToken()

<div class="table-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Pickup Slots</h3>
        <div class="d-flex align-items-center gap-2">
            <label class="mb-0">Date</label>
            <input id="slotDate" type="date" class="form-control form-control-sm" />
            <button id="refreshSlots" class="btn btn-sm btn-outline-secondary">Refresh</button>
        </div>
    </div>

    <p class="text-muted">Manage slot capacities and availability to control kitchen load. Blocking a slot prevents new bookings for that date.</p>

    <div id="slotsContainer" class="row g-3">
        <!-- slot cards injected here -->
    </div>

    <div id="noSlots" class="no-records" style="display:none;">
        No pickup slots configured.
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>

    <script>
        (function () {
            const token = $('input[name="__RequestVerificationToken"]').first().val();

            function formatBadge(status) {
                if (status === 'Open') return '<span class="badge slot-open">Open</span>';
                if (status === 'Full') return '<span class="badge slot-full">Full</span>';
                if (status === 'Disabled') return '<span class="badge slot-disabled">Disabled</span>';
                return '<span class="badge bg-secondary">Unknown</span>';
            }

            function renderSlots(slots) {
                const $c = $('#slotsContainer').empty();
                if (!slots || slots.length === 0) {
                    $('#noSlots').show();
                    return;
                }
                $('#noSlots').hide();

                slots.forEach(s => {
                    const slotId = s.SlotId;
                    const label = s.SlotLabel || ('Slot ' + slotId);
                    const timeRange = (s.StartTime || '') + (s.EndTime ? ' — ' + s.EndTime : '');
                    const capacity = s.Capacity ?? 0;
                    const current = s.CurrentBookings ?? 0;
                    const status = s.Status || 'Open';
                    const blocked = s.IsBlockedForDate === true;

                    const $card = $(`
                        <div class="col-md-6">
                            <div class="slot-card p-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">${label}</h6>
                                        <div class="text-muted small">${timeRange}</div>
                                    </div>
                                    <div class="text-end">
                                        ${formatBadge(status)}
                                        ${blocked ? '<div class="small text-danger mt-1">Blocked for date</div>' : ''}
                                    </div>
                                </div>

                                <div class="d-flex gap-2 align-items-center mt-3">
                                    <label class="mb-0 small">Capacity</label>
                                    <input type="number" min="0" class="form-control form-control-sm capacity-input" data-id="${slotId}" value="${capacity}" style="width:100px" />
                                    <div class="small text-muted ms-2">Current: <strong class="current-count">${current}</strong></div>
                                </div>

                                <div class="mt-3 d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary save-capacity" data-id="${slotId}">Save</button>
                                    <button class="btn btn-sm btn-toggle" data-id="${slotId}" data-disabled="${s.IsDisabled}">${s.IsDisabled ? 'Enable' : 'Disable'}</button>
                                    <button class="btn btn-sm btn-outline-danger block-slot" data-id="${slotId}">${blocked ? 'Unblock' : 'Block for date'}</button>
                                </div>
                            </div>
                        </div>
                    `);

                    $card.find('.save-capacity').on('click', function () {
                        const id = $(this).data('id');
                        const cap = $card.find('.capacity-input').val();
                        if (isNaN(cap) || cap < 0) { alert('Invalid capacity'); return; }
                        $.post({
                            url: '/Admin/UpdateSlotCapacity',
                            data: { slotId: id, capacity: parseInt(cap), __RequestVerificationToken: token },
                            dataType: 'json'
                        }).done(function (res) {
                            if (res && res.success) {
                                $card.find('.current-count').text(res.currentBookings ?? current);
                                alert('Capacity saved');
                                $(document).trigger('orders:refresh');
                            } else {
                                alert(res?.message || 'Failed to save capacity');
                            }
                        }).fail(function () { alert('Server error'); });
                    });

                    $card.find('.btn-toggle').on('click', function () {
                        const id = $(this).data('id');
                        const isDisabled = $(this).data('disabled') ? false : true;
                        const $btn = $(this);
                        $.post({
                            url: '/Admin/UpdateSlotStatus',
                            data: { slotId: id, isDisabled: isDisabled, __RequestVerificationToken: token },
                            dataType: 'json'
                        }).done(function (res) {
                            if (res && res.success) {
                                $btn.text(res.isDisabled ? 'Enable' : 'Disable');
                                $btn.data('disabled', res.isDisabled);
                                $card.find('.slot-card').toggleClass('slot-disabled', res.isDisabled);
                                $(document).trigger('orders:refresh');
                            } else {
                                alert(res?.message || 'Failed to update slot');
                            }
                        }).fail(function () { alert('Server error'); });
                    });

                    $card.find('.block-slot').on('click', function () {
                        const id = $(this).data('id');
                        const date = $('#slotDate').val();
                        if (!date) { alert('Select a date first'); return; }
                        const $btn = $(this);
                        const isBlocked = blocked;
                        // toggle block/unblock
                        $.post({
                            url: '/Admin/ToggleSlotBlock',
                            data: { slotId: id, date: date, __RequestVerificationToken: token },
                            dataType: 'json'
                        }).done(function (res) {
                            if (res && res.success) {
                                alert(res.message || 'Updated');
                                fetchSlots();
                            } else {
                                alert(res?.message || 'Failed');
                            }
                        }).fail(function () { alert('Server error'); });
                    });

                    $c.append($card);
                });
            }

            function fetchSlots() {
                const date = $('#slotDate').val() || new Date().toISOString().slice(0,10);
                $.ajax({
                    url: '/Admin/GetPickupSlots',
                    method: 'GET',
                    data: { date: date },
                    dataType: 'json'
                }).done(function (res) {
                    renderSlots(res);
                }).fail(function () { alert('Failed to load slots'); });
            }

            // init
            $(function () {
                // default to today
                $('#slotDate').val(new Date().toISOString().slice(0,10));
                $('#refreshSlots').on('click', fetchSlots);
                fetchSlots();

                // respond to global refresh event
                $(document).on('orders:refresh', fetchSlots);
            });
        })();
    </script>
}
