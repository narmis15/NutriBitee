@{
    ViewData["Title"] = "Calorie Analytics";
    var uid = ViewBag.UserId ?? Context.Request.Query["userId"].ToString();
}

<link rel="stylesheet" href="~/css/Users.css" />
<link rel="stylesheet" href="~/css/users-calorie.css" />

<div class="users-page">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h3 class="page-title">Calorie Consumption Analytics</h3>
            <small class="text-muted">Average intake, trend and comparison against recommended levels</small>
        </div>

        <div class="d-flex gap-2 align-items-center">
            <label class="mb-0 small">From</label>
            <input id="fromDate" type="date" class="form-control form-control-sm" />
            <label class="mb-0 small ms-2">To</label>
            <input id="toDate" type="date" class="form-control form-control-sm" />
            <button id="applyBtn" class="btn btn-sm btn-primary ms-2">Apply</button>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-md-4">
            <div class="summary-card p-3">
                <div class="title">Avg Daily Intake</div>
                <div id="avgDaily" class="value">- kcal</div>
                <div class="sub text-muted">Average calories per day</div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="summary-card p-3">
                <div class="title">Peak Day</div>
                <div id="peakDaily" class="value">- kcal</div>
                <div class="sub text-muted">Highest single-day intake</div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="summary-card p-3">
                <div class="title">Compared to Recommended</div>
                <div id="compPercent" class="value">- %</div>
                <div class="sub text-muted">Percentage of recommended intake</div>
            </div>
        </div>
    </div>

    <div class="card p-3 mb-3">
        <div class="card-header mb-2"><h5 class="mb-0">Calories Over Time</h5></div>
        <canvas id="calorieTrend" height="160"></canvas>
    </div>

    <div id="alerts" class="mb-3"></div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        (function () {
            const uid = '@uid';
            const api = '/Users/GetCalorieAnalyticsData';

            function iso(d) { return d.toISOString().slice(0,10); }

            function initDates() {
                const to = new Date();
                const from = new Date(); from.setDate(to.getDate() - 13);
                $('#fromDate').val(iso(from));
                $('#toDate').val(iso(to));
            }

            function renderAlerts(alerts) {
                const $a = $('#alerts').empty();
                if (!alerts || !alerts.length) return;
                alerts.forEach(al => {
                    const cls = al.level === 'warning' ? 'alert-warning' : 'alert-info';
                    $a.append('<div class="alert ' + cls + ' small mb-1" role="alert">' + (al.message || al.Message) + '</div>');
                });
            }

            let chart = null;
            function renderChart(points) {
                const labels = points.map(p => p.label || p.Label);
                const data = points.map(p => p.calories ?? p.Calories);

                const ctx = document.getElementById('calorieTrend').getContext('2d');
                if (chart) {
                    chart.data.labels = labels;
                    chart.data.datasets[0].data = data;
                    chart.update();
                    return;
                }

                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Calories',
                            data: data,
                            borderColor: '#16a34a',
                            backgroundColor: 'rgba(22,163,74,0.08)',
                            pointRadius: 3,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,   // keep stable sizing to avoid resize loops
                        animation: false,            // render statically (no continuous animation)
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }

            function renderSummary(m) {
                $('#avgDaily').text((m.averageDaily ?? m.AverageDaily ?? 0) + ' kcal');
                $('#peakDaily').text((m.peakDaily ?? m.PeakDaily ?? 0) + ' kcal');
                $('#compPercent').text((m.comparisonPercent ?? m.ComparisonPercent ?? 0) + ' %');
            }

            function load() {
                const from = $('#fromDate').val();
                const to = $('#toDate').val();
                $.getJSON(api, { userId: uid || 0, from: from, to: to })
                    .done(function (res) {
                        renderSummary(res);
                        renderChart(res.trend || res.Trend || []);
                        renderAlerts(res.alerts || res.Alerts || []);
                    }).fail(function () {
                        alert('Failed to load analytics data');
                    });
            }

            $(function () { initDates(); load(); $('#applyBtn').on('click', load); });
        })();
    </script>
}
