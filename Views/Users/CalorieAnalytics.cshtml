@{
    ViewData["Title"] = "My Calorie Dashboard";
    Layout = "~/Views/Shared/_PublicLayout.cshtml";
}

<div class="container py-5">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <h2 class="mb-1">My Calorie Dashboard</h2>
            <small class="text-muted" id="userLabel">Loading…</small>
        </div>

        <div class="d-flex gap-2 align-items-center">
            <label class="m-0 me-2 text-muted">From</label>
            <input type="date" id="fromDate" class="form-control form-control-sm" />
            <label class="m-0 ms-3 me-2 text-muted">To</label>
            <input type="date" id="toDate" class="form-control form-control-sm" />
            <button id="refreshBtn" class="btn btn-success btn-sm ms-3">Refresh</button>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <div class="small text-muted">Average / day</div>
                <div class="h4 mt-2" id="avgDaily">— kcal</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <div class="small text-muted">Peak (day)</div>
                <div class="h4 mt-2" id="peakDaily">— kcal</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <div class="small text-muted">Recommended</div>
                <div class="h4 mt-2" id="recommendedDaily">— kcal</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card p-3 shadow-sm">
                <div class="small text-muted">Comparison</div>
                <div class="h4 mt-2" id="comparisonPct">— %</div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card p-3 shadow-sm mb-3">
                <canvas id="calorieChart" height="220" aria-label="Calorie trend chart" role="img"></canvas>
            </div>

            <div id="alertsContainer" class="mb-4"></div>
        </div>

        <div class="col-lg-4">
            <div class="card p-3 shadow-sm">
                <h5 class="mb-3">Summary</h5>
                <div id="summaryContent">
                    <p class="text-muted mb-1">Use the date selectors above to filter the analytics.</p>
                    <ul class="list-unstyled" id="trendList"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        (function () {
            const $avg = document.getElementById('avgDaily');
            const $peak = document.getElementById('peakDaily');
            const $rec = document.getElementById('recommendedDaily');
            const $cmp = document.getElementById('comparisonPct');
            const $userLabel = document.getElementById('userLabel');
            const $alerts = document.getElementById('alertsContainer');
            const $trendList = document.getElementById('trendList');
            const ctx = document.getElementById('calorieChart').getContext('2d');

            let chart = null;

            // set default dates: last 14 days
            function toIsoDate(d) {
                const tzOff = d.getTimezoneOffset() * 60000;
                return new Date(d - tzOff).toISOString().slice(0, 10);
            }
            const today = new Date();
            const twoWeeksAgo = new Date(); twoWeeksAgo.setDate(today.getDate() - 13);

            document.getElementById('fromDate').value = toIsoDate(twoWeeksAgo);
            document.getElementById('toDate').value = toIsoDate(today);

            function renderAlerts(alerts) {
                $alerts.innerHTML = '';
                if (!alerts || !alerts.length) return;
                alerts.forEach(a => {
                    const level = (a.level || a.Level || 'info').toLowerCase();
                    const cls = level === 'warning' ? 'alert-warning' : (level === 'danger' || level === 'error' ? 'alert-danger' : 'alert-info');
                    const div = document.createElement('div');
                    div.className = 'alert ' + cls + ' py-2';
                    div.textContent = a.message || a.Message || '';
                    $alerts.appendChild(div);
                });
            }

            function renderTrendList(trend) {
                $trendList.innerHTML = '';
                if (!trend || !trend.length) return;
                trend.slice().reverse().forEach(pt => {
                    const li = document.createElement('li');
                    li.className = 'mb-2';
                    li.innerHTML = `<strong>${pt.Label || pt.label}</strong> — ${(pt.Calories ?? pt.calories ?? pt.cal) } kcal`;
                    $trendList.appendChild(li);
                });
            }

            function fetchData() {
                const from = document.getElementById('fromDate').value;
                const to = document.getElementById('toDate').value;

                $.getJSON('/Users/GetCalorieAnalyticsData', { from: from || null, to: to || null })
                    .done(function (model) {
                        if (!model) return;

                        $userLabel.textContent = model.UserName || model.userName || '';

                        $avg.textContent = (model.AverageDaily ?? model.averageDaily ?? '—') + ' kcal';
                        $peak.textContent = (model.PeakDaily ?? model.peakDaily ?? '—') + ' kcal';
                        $rec.textContent = (model.RecommendedDaily ?? model.recommendedDaily ?? '—') + ' kcal';
                        $cmp.textContent = (model.ComparisonPercent ?? model.comparisonPercent ?? '—') + ' %';

                        renderAlerts(model.Alerts || model.alerts || []);
                        renderTrendList(model.Trend || model.trend || []);

                        // prepare chart data
                        const trend = model.Trend || model.trend || [];
                        const labels = trend.map(x => x.Label || x.label);
                        const data = trend.map(x => x.Calories ?? x.calories ?? x.cal ?? 0);

                        if (chart) {
                            chart.data.labels = labels;
                            chart.data.datasets[0].data = data;
                            chart.update();
                        } else {
                            chart = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Calories',
                                        data: data,
                                        borderColor: '#16a34a',
                                        backgroundColor: 'rgba(22,163,74,0.08)',
                                        fill: true,
                                        tension: 0.25,
                                        pointRadius: 3
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: { mode: 'index', intersect: false }
                                    },
                                    scales: {
                                        x: { display: true },
                                        y: {
                                            beginAtZero: true,
                                            title: { display: true, text: 'kcal' }
                                        }
                                    }
                                }
                            });
                        }
                    })
                    .fail(function () {
                        $userLabel.textContent = '';
                        $avg.textContent = '— kcal';
                        $peak.textContent = '— kcal';
                        $rec.textContent = '— kcal';
                        $cmp.textContent = '— %';
                        $alerts.innerHTML = '<div class="alert alert-danger py-2">Unable to load analytics. Try again.</div>';
                    });
            }

            document.getElementById('refreshBtn').addEventListener('click', function () {
                fetchData();
            });

            // initial load
            fetchData();
        })();
    </script>
}
