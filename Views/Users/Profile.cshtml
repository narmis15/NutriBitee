@{
    ViewData["Title"] = "User Profile";
    var userId = ViewBag.UserId ?? Context.Request.Query["userId"].ToString();
}

<link rel="stylesheet" href="~/css/Users.css" />

<div class="users-page">
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <h3 class="page-title">User Profile</h3>
            <small class="text-muted">Health snapshot and account summary</small>
        </div>

        <div class="text-end">
            <a asp-controller="Users" asp-action="Index" class="btn btn-sm btn-outline-secondary">Back to users</a>
        </div>
    </div>

    <div class="row g-3">
        <!-- Left: Profile summary -->
        <div class="col-lg-4">
            <div class="user-card">
                <div class="user-avatar">@((userId ?? "U").ToString().Substring(0,1))</div>
                <div class="user-info">
                    <div class="name" id="u-name">—</div>
                    <div class="meta" id="u-contact">—</div>

                    <div class="user-badges" style="margin-top:10px">
                        <span id="u-status" class="badge badge-muted">Status</span>
                        <span id="u-diet" class="badge badge-muted">Diet</span>
                        <span id="u-orders" class="badge badge-muted">Orders</span>
                    </div>

                    <div class="calorie-row">
                        <div style="width:100%;">
                            <div class="small text-muted">Today: <span id="u-today-cal">0</span> kcal / Goal: <span id="u-goal-cal">0</span> kcal</div>
                            <div class="calorie-bar mt-2">
                                <div id="u-cal-fill" class="calorie-fill" style="width:0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <strong>Admin note</strong>
                        <div class="small text-muted" id="u-note">—</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: trend chart + details -->
        <div class="col-lg-8">
            <div class="card p-3 mb-3">
                <div class="card-header mb-2">
                    <h4 class="mb-0">Weekly Calorie Trend</h4>
                </div>
                <canvas id="weeklyTrendChart" height="120"></canvas>
            </div>

            <div class="card p-3">
                <h5>Details</h5>
                <table class="users-table" style="margin-top:10px">
                    <tbody>
                        <tr><td style="width:180px"><strong>User ID</strong></td><td id="d-userid">—</td></tr>
                        <tr><td><strong>Registered</strong></td><td id="d-registered">—</td></tr>
                        <tr><td><strong>Average (7d)</strong></td><td id="d-weekly-avg">— kcal</td></tr>
                        <tr><td><strong>Orders</strong></td><td id="d-orders">—</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        (function () {
            const id = '@userId';
            const api = '/Users/GetUserProfileData?userId=' + encodeURIComponent(id);

            function setStatusBadge(el, status) {
                const $el = $(el);
                $el.removeClass().addClass('badge');
                if (!status) { $el.addClass('badge-muted').text('Unknown'); return; }
                if (status === 'Active') $el.addClass('badge-success').text('Active');
                else if (status === 'At Risk') $el.addClass('badge-warning').text('At Risk');
                else if (status === 'Inactive') $el.addClass('badge-muted').text('Inactive');
                else if (status === 'Blocked') $el.addClass('badge-danger').text('Blocked');
                else $el.addClass('badge-muted').text(status);
            }

            let trendChart = null;
            function renderTrend(points) {
                const labels = points.map(p => p.label || p.Label);
                const data = points.map(p => p.calories ?? p.Calories);

                const ctx = document.getElementById('weeklyTrendChart').getContext('2d');
                if (trendChart) {
                    trendChart.data.labels = labels;
                    trendChart.data.datasets[0].data = data;
                    trendChart.update();
                    return;
                }

                trendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Calories',
                            data: data,
                            borderColor: '#16a34a',
                            backgroundColor: 'rgba(22,163,74,0.08)',
                            pointRadius: 4,
                            tension: 0.25,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,     // keep a stable aspect ratio
                        animation: false,              // disable continuous/entrance animations
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false } },
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            function load() {
                $.getJSON(api).done(function (m) {
                    $('#u-name').text(m.name || m.Name);
                    $('#u-contact').html((m.email || '') + '<br/>' + (m.phone || ''));
                    setStatusBadge('#u-status', (m.status || m.Status));
                    $('#u-diet').text(m.dietType || m.DietType);
                    $('#u-orders').text((m.ordersCount || m.OrdersCount) + ' orders');
                    $('#u-today-cal').text(m.todayCalories || m.TodayCalories);
                    $('#u-goal-cal').text(m.calorieGoal || m.CalorieGoal);
                    $('#u-note').text(m.adminNote || m.AdminNote || '—');

                    const goal = (m.calorieGoal || m.CalorieGoal) || 1;
                    const today = (m.todayCalories || m.TodayCalories) || 0;
                    const pct = Math.min(100, Math.round((today / goal) * 100));
                    $('#u-cal-fill').css('width', pct + '%');

                    $('#d-userid').text(m.userId || m.UserId);
                    $('#d-registered').text(new Date(m.registeredAt || m.RegisteredAt).toLocaleDateString());
                    $('#d-weekly-avg').text((m.weeklyCaloriesAverage || m.WeeklyCaloriesAverage) + ' kcal');
                    $('#d-orders').text(m.ordersCount || m.OrdersCount);

                    renderTrend(m.weeklyTrend || m.WeeklyTrend || []);
                }).fail(function () {
                    alert('Failed to load profile data');
                });
            }

            $(function () { load(); });
        })();
    </script>
}